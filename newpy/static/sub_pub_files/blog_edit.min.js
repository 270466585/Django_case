define("blog_edit",["globalUtil"],function(t){"use strict";var e=function(){this.tags=[],this.formElement=$("#blog-form"),this.stashDraftsTimer=null,this.draft_id="",this.isSaveBlog=!1,this.canStashBlog=!0,this.networkErrorStr="未能连接服务器",this.toolTipTimer=null,this.isAllowStashAuto=!1};return e.prototype={constructor:e,_tooltips:function(t){var e,a=this,i={tooltipsBox:$(".tooltips-box"),tooltips:$("#error_tip"),duration:2e3};i.tooltips.length>=1&&i.tooltipsBox.length>=1&&($(i.tooltips).html(t),e=($(window).height()-i.tooltips.height())/2,$(i.tooltipsBox).css("top",e),$(i.tooltips).css("display","inline-block").css("opacity",1),a.toolTipTimer=null,a.toolTipTimer=setTimeout(function(){$(i.tooltips).css("opacity",0).css("display","none")},i.duration))},_tagsOption:{tagInputHiddenEle:$("#input_tags"),tagBoxEle:$(".tags"),autoPromptEle:$(".autoPrompt"),tagInputEle:$(".input-tags")},initTagsInput:function(){var t=this,e=page.tags,a=e.split(",");t.tags=[],a.length>0&&a.forEach(function(e,a){$.trim(e)&&t._concatTags(e)}),t._testInputDisable()},_deleteLastTags:function(){var t=this,e=t._tagsOption.tagBoxEle.find(".tags-item:last"),a=$.inArray(e,t.tags);t.tags.splice(a,1),t._tagsOption.tagInputHiddenEle.val(t.tags),$(e).remove(),t._testInputDisable()},_concatTags:function(t){var e=this,a=$("<span>").addClass("tags-item"),i=$("<span class='tag-name'></span>").html(t),o=$(a).append($(i)).append("<span class='close'>×</span>");$.inArray(t,e.tags)==-1?(e._tagsOption.tagInputEle.attr("disabled",!0),e._tagsOption.tagBoxEle.append($(o)),e._tagsOption.tagInputEle.val(""),e.tags.push(t),e._tagsOption.tagInputHiddenEle.val(e.tags),e._tagsOption.autoPromptEle.hide().empty(),e._tagsOption.tagInputEle.attr("disabled",!1)):e._tooltips("关键词重复"),e._testInputDisable()},_testInputDisable:function(){var t=this,e=t.tags.length;return e>=5?(t._tagsOption.tagInputEle.css("display","none"),t._tagsOption.autoPromptEle.hide().empty(),!0):(t._tagsOption.tagInputEle.css("display","inline-block"),!1)},_autoPromptTags:function(t){var e=this,a={};a.keyword=t,a.user_code=page.user_code,t?$.ajax({url:page.tag_prompt_url,method:"post",data:a,success:function(t){var a,i,o=t.data?t.data:"";o.length>0&&!e._testInputDisable()?(a="",i=o.forEach(function(t,e,i){a+="<li>"+t+"</li>"}),e._tagsOption.autoPromptEle.show().empty().append(a)):e._tagsOption.autoPromptEle.hide().empty()},error:function(){e._tooltips(e.networkErrorStr)}}):e._tagsOption.autoPromptEle.hide().empty()},deleteTags:function(){var t=this;t._tagsOption.tagBoxEle.delegate(".close","click",function(){var e=$(this).parents(".tags-item").find(".tag-name").html(),a=$.inArray(e,t.tags);t.tags.splice(a,1),t._tagsOption.tagInputHiddenEle.val(t.tags),$(this).parents(".tags-item").remove(),t._testInputDisable()})},addTags:function(){var t=this;t._tagsOption.tagInputEle.bind("input propertychange",function(e){var a=$(this).val(),i=a.charAt(a.length-1),o=a.substring(0,a.length-1);t._tagsOption.tagInputHiddenEle.val(t.tags+","+a),","===i&&($(this).val(o),o.length>=1&&(t._concatTags(o),t._tagsOption.autoPromptEle.hide().empty())),t._testInputDisable()||t._autoPromptTags(a)}),t._tagsOption.tagInputEle.bind("keydown",function(e){var a,i=$(this),o=t._tagsOption.autoPromptEle.find("li");return t._testInputDisable(),a=$(this).val().trim(),13==e.which&&a?(t._concatTags(a),t._tagsOption.autoPromptEle.hide().empty(),!1):void(8!=e.which||a?40==e.which?o.length>=1&&(!o.hasClass("active")||o.filter(":last").hasClass("active")?(o.filter(":last").removeClass("active"),o.eq(0).addClass("active"),i.val(o.filter(".active").html())):(o.filter(".active").removeClass("active").next("li").addClass("active"),i.val(o.filter(".active").html()))):38==e.which&&o.length>=1&&(!o.hasClass("active")||o.filter(":first").hasClass("active")?(o.filter(":first").removeClass("active"),o.eq(-1).addClass("active"),i.val(o.filter(".active").html())):(o.filter(".active").removeClass("active").prev("li").addClass("active"),i.val(o.filter(".active").html()))):t._deleteLastTags())}),t._tagsOption.autoPromptEle.delegate("li","click",function(e){var a=$(this).html();t._concatTags(a),t._tagsOption.autoPromptEle.hide().empty()})},_deleteCatalogAjax:function(t,e){var a={};a.space=page.g_user_id,a.user_code=page.user_code,a.id=t,$.ajax({url:page.delete_catalog_url,method:"post",data:a,dataType:"json",success:function(t){if(1==t.result)e(t);else{var a=$("<span></span>").addClass("error-tips").html(t.msg);$(".add-sort .error-tips").remove(),$(".add-sort").append(a)}},error:function(){_this._tooltips(_this.networkErrorStr)}})},addCatalog:function(){var t=this,e={catalogInputEle:$(".input-add-sort"),catalogItemsEle:$(".sort-items")};e.catalogInputEle.bind("keydown",function(a){function i(t,e){t.addClass("error");var a=$("<span></span>").addClass("error-tips").html(e);$(".add-sort .error-tips").remove(),$(a).insertAfter(t)}function o(t){t.val(""),t.removeClass("error"),$(".add-sort .error-tips").remove()}var s,n,l,r,d=$(this),c=$.trim($(this).val());""==c&&$(this).siblings(".error-tips").length>0&&($(d).removeClass("error"),$(this).siblings(".error-tips").remove()),13==a.which&&c&&(s=$("<div></div>").addClass("select-opt"),n=$("<span></span>").addClass("close").html("×"),l=$("<span></span>").addClass("opt-name"),r={},r.space=page.g_user_id,r.user_code=page.user_code,r.name=c,$.ajax({url:page.add_catalog_url,method:"post",data:r,dataType:"json",success:function(t){var a,r;t.result&&t.data?($(l).html(c.substring(0,c.length)),$(s).append($(l)),$(s).append($(n)),$(s).attr("data-value",t.data.id),e.catalogItemsEle.append($(s)),e.catalogItemsEle.scrollTop(e.catalogItemsEle[0].scrollHeight),o($(d)),a=t.data.id,$(s).addClass("active").siblings(".select-opt").removeClass("active"),$(s).parents(".select-box").find(".select-show").html(c.substring(0,c.length)).data("value",a),$(s).parents(".select-box").find(".drop-input").val(a)):!t.result&&t.msg&&i($(d),t.msg),r=$(".edit-catalog .select-show").data("value"),localStorage.setItem("blog_sort",r)},error:function(){t._tooltips(t.networkErrorStr)}}))})},deleteCatalog:function(){var t=this;$(".sort-items").delegate(".close","click",function(e){var a,i,o;return e.stopPropagation(),a=$(this).parents(".select-opt"),i=$(a).data("value"),o=$(this).parents(".select-box").find(".drop-input").val(),i==o&&($(this).parents(".sort-items").find(".select-opt").eq(0).trigger("click"),localStorage.setItem("blog_sort","")),t._deleteCatalogAjax(i,function(){$(a).remove()}),!1})},offonToggle:function(){$(".edit-panel input[type=checkbox]").bind("change",function(){var t=$(this).val(),e=$(this).parents("li").find(".offon");e.hasClass("active")?e.removeClass("active"):e.addClass("active"),0==t?$(this).val(1):$(this).val(0)})},_textareaAutoHeight:function(t,e,a){var i=function(t,e,a){var i,o,s=parseInt(t.css("padding-top"))+parseInt(t.css("padding-bottom"));a&&(i=$(window).scrollTop(),t.height(e)),o=t[0].scrollHeight,o>e?t.height(o-s):t.height(e),a&&$(window).scrollTop(i)},o=function(t,e,a){i(t,e);var o=null;t.bind("input change",function(s){o&&(clearTimeout(o),o=null),o=setTimeout(function(){i(t,e),a&&a(s)},50)}).bind("keyup",function(a){8!=a.which&&(!a.metaKey&&!a.ctrlKey||88!=a.which&&90!=a.which)&&46!=a.which||i(t,e,!0)})};o(t,e,a)},mdeditorTextAreaFlex:function(){var t,e,a=this,i=$(window).height()-$(".edit-box").offset().top-285;$("#mdeditor").length>=1&&a._textareaAutoHeight($("#mdeditor"),i),t=!1,$(".edit-box").delegate([".md-control-fullscreen",".exit-fullscreen"],"click",function(){t=!t,!t&&$("#mdeditor").length>=1&&a._textareaAutoHeight($("#mdeditor"),i)}),e=!1,$(".edit-box").delegate("[data-handler='bootstrap-markdown-cmdPreview']","click",function(){e=!e,!e&&$("#mdeditor").length>=1&&a._textareaAutoHeight($("#mdeditor"),i)})},goToTop:function(){$(window).on("scroll",function(){$(this).scrollTop()>0?$(".tool-top").css("display","block"):$(".tool-top").css("display","none")}),$(".tool-top").on("click",function(t){return t.preventDefault(),$("body").animate({scrollTop:0},200),!1})},selectValue:function(){var t=this;$(".select-box:not(.select-editor)").delegate(".select-opt","click",function(){var e,a="";a=$(this).find(".opt-name").length>0?$(this).find(".opt-name").text():$(this).text(),e=$(this).data("value"),$(this).addClass("active").siblings(".select-opt").removeClass("active"),$(this).parents(".select-box").find(".select-show").html(a).data("value",e),$(this).parents(".select-box").find(".drop-input").val(e),$(this).parents(".select-box").find(".dropdown").css("display","none"),t._formDataListenHandle()}),$(".select-box:not(.select-editor)").on("mouseover",function(t){$(this).find(".dropdown").css("display","block")}).on("mouseleave",function(){$(this).find(".dropdown").css("display","none")})},_edit_catalog_default:function(){var t,e,a=localStorage.getItem("blog_sort"),i=$(".edit-catalog"),o=i.find(".select-box .sort-items .select-opt");null!=a&&(t=i.find(".select-box #self_sort"),e=i.find(".select-box .select-show"),o.each(function(i,o){var s=$(o).data("value");a==s&&($(o).addClass("active"),t.val(s),e.attr("data-value",s).text($(o).text()))})),o.on("click",function(){var t=$(this).data("value");localStorage.setItem("blog_sort",t)})},_serializeObj:function(t){var e=$(t).find("input[name]"),a=$(t).find("input[name]:checked"),i=$(t).find("textarea[name]"),o={};return e.each(function(t,e){o[$(e).attr("name")]=$(e).val()}),a.each(function(t,e){o[$(e).attr("name")]=$(e).val()}),i.each(function(t,e){o[$(e).attr("name")]=$(e).val()}),o},_saveBlog:function(t){var e=this,a=$("#blog-form");$(a).bind("blogSubmit",function(){e.isSaveBlog=!0;var i={};i=e._serializeObj($(a)),$.ajax({url:t,method:"post",dataType:"json",data:i,success:function(t){if(1==t.error&&e._tooltips(t.msg),t.id){$(".btn-save").html("正在发布").addClass("btn-disabled"),window.onbeforeunload=null;var a=page.blog_url+"/"+t.id;window.location.href=a}},error:function(t){e._tooltips(e.networkErrorStr)}})})},_checkCanSaveBlog:function(){var t=$("#blog-form"),e=(page.is_draft,null);e=setTimeout(function(){var a=$(t).find("input[name=title]").val().trim(),i=$(t).find("textarea[name=content]").val().trim();""!=a&&""!=i?($(".stash-draft").removeClass("btn-disabled"),$(".btn-save").removeClass("btn-disabled")):$(".btn-save").hasClass("btn-disabled")||($(".stash-draft").addClass("btn-disabled"),$(".btn-save").addClass("btn-disabled")),e&&(clearTimeout(e),e=null)},200)},saveBlog:function(){var t=this,e=$("#blog-form"),a=page.is_draft;$("input[name=title]").on("input propertychange",function(){t._checkCanSaveBlog()}),$(".btn-save").bind("click",function(){var i=$(e).find("input[name=title]").val().trim(),o=$(e).find("textarea[name=content]").val().trim(),s=$(e).find("input[name=classification]").val();$(e).find("input[name=type]:checked").val(),$(e).find("input[name=origin_url]").val();""==i?t._tooltips("文章标题不能为空"):""==o?t._tooltips("文章内容不能为空"):"0"==s||""==s?(t._tooltips("未选择系统博客分类"),$(window).scrollTop($(".edit-body")[0].scrollHeight),$(".edit-sys-sort").addClass("error"),$(".edit-sys-sort .select-box").bind("mouseover",function(){$(".edit-sys-sort").removeClass("error")})):0==t.isSaveBlog&&"false"==a?(t._saveBlog(page.save_url),$(e).trigger("blogSubmit")):0==t.isSaveBlog&&"true"==a&&(t._saveBlog(page.save_url+"?publish_as_blog=1&draft=true"),$(e).trigger("blogSubmit"))})},_stashDraf:function(t){function e(e){$.ajax({url:e,method:"post",data:r,dataType:"json",success:function(e){var i,o,s;e.msg||1==e.error?1==e.error?(a.canStashBlog=!1,a.stashDraftsTimer&&(clearTimeout(a.stashDraftsTimer),a.stashDraftsTimer=null)):a._tooltips(e.msg):(i=e.draft,a.draft_id=e.draft,$("input[name='draft']").val(e.draft),o=new Date,s=t?$("<span></span>").addClass("tips").html("已保存"):$("<span></span>").addClass("tips").html(o.getHours()+":"+o.getMinutes()+":"+o.getSeconds()+"保存"),$(".stash-draft").html("保存草稿").append(s))},error:function(){a._tooltips(a.networkErrorStr)}})}var a=this,i=$("#blog-form"),o=$(i).find("input[name=title]").val().trim(),s=$(i).find("textarea[name=content]").val().trim(),n=page.is_edit,l=page.is_draft,r=a._serializeObj($(i));""!=o&&""!=s&&a.canStashBlog&&("false"==n?e(page.save_url+"?save_as_draft=1"):"true"==l&&e(page.save_url+"?draft=true"))},stashDraf:function(){function t(){a.isAllowStashAuto&&(a._stashDraf(),a.isAllowStashAuto=!1),a.stashDraftsTimer&&(clearTimeout(a.stashDraftsTimer),a.stashDraftsTimer=null),a.stashDraftsTimer=setTimeout(t,5e3)}var e,a=this,i=page.is_edit,o=page.is_draft;"false"!=i&&"true"!=o||(a.draft_id=page.draft_id,e=$("#blog-form"),$(".stash-draft").bind("click",function(){var t=$(e).find("input[name=title]").val().trim(),i=$(e).find("textarea[name=content]").val().trim();""==t?a._tooltips("文章标题不能为空"):""==i?a._tooltips("文章内容不能为空"):a._stashDraf()}),setTimeout(t,5e3))},_ckeditorInit:function(){var t=this,e=CKEDITOR.instances.ckeditor,a=!1,i=!1,o=null,s=($("#cke_ckeditor"),$("#cke_1_contents"),$(window).height()-$(".edit-box").offset().top-255);e&&e.destroy(!0),e=CKEDITOR.replace("ckeditor"),e.on("instanceReady",function(n){function l(){var i=$(".cke_wysiwyg_frame").contents().find("body").height()+40;i>=s?$("#cke_1_contents").height(i):$("#cke_1_contents").height(s),e.on("change",function(e){if(o&&(clearTimeout(o),o=null),o=setTimeout(function(){$("#ckeditor").val(e.editor.getData()),""!=$("#ckeditor").val()&&t._formDataListenHandle()},200),a)$(".cke_wysiwyg_frame").contents().find(".cke_editable").css("overflowY","auto");else{var i=$(".cke_wysiwyg_frame").contents().find("body").height()+40;$(".cke_wysiwyg_frame").contents().find(".cke_editable").css("overflowY","hidden"),$("#cke_1_contents").css("overflowY","hidden"),i>=s?$("#cke_1_contents").height(i):$("#cke_1_contents").height(s)}})}function r(){a&&($(".cke_source").on("change input",function(){$(this).height("100%"),$(this).css("maxHeight","100%")}),$(".cke_source").height("100%"),$(".cke_source").css("maxHeight","100%"),setTimeout(function(){$("#cke_1_contents").height($(window).height()-60),$(".cke_wysiwyg_frame").contents().find(".cke_editable").css("overflow","auto")},0)),i&&!a?setTimeout(function(){t._textareaAutoHeight($(".cke_source"),s),$("#cke_1_contents").height("auto")},0):i||a||setTimeout(function(){$(".cke_wysiwyg_frame").contents().find(".cke_editable").css("overflowY","hidden"),l()},0)}$(n.editor.document.$).on("keydown",function(e){if((e.metaKey||e.ctrlKey)&&83==e.keyCode)return e.preventDefault(),e.returnvalue=!1,t._stashDraf(),!1}),l(),$("#cke_ckeditor").delegate(".cke_button__maximize","click",function(t){a=!!$(this).hasClass("cke_button_on"),r()}),$("#cke_ckeditor").delegate(".cke_button__source","click",function(t){i=!i,r()})})},_thinkerMdInit:function(){var t=this;$("#mdeditor").markdown({resize:"none",language:"zh",imgurl:page.mdeditor_img_upload_url,hiddenButtons:"cmdEmoji",disabledButtons:"cmdEmoji",maxFileSize:2097152,fullscreen:{enable:!0}}),$.fn.markdown.messages.zh.FileSizeTip="上传文件不能大于2Mb",$("#mdeditor").length>=1&&($("#mdeditor").height($("#mdeditor")[0].scrollHeight),$("#mdeditor").on("keydown",function(e){if((e.metaKey||e.ctrlKey)&&83==e.keyCode)return e.preventDefault(),e.returnvalue=!1,t._stashDraf(),!1}).on("input propertychange",function(){t._formDataListenHandle()}))},initEditor:function(){var t=page.blog_editor;3==t?this._thinkerMdInit():4==t&&this._ckeditorInit()},toggleEditor:function(){function t(t){$(".editor-content").val("");var a={};a.space=page.g_user_id,a.user_code=page.user_code,a.blog_editor=t,$.ajax({url:page.toggle_editor_url,method:"get",data:a,success:function(t){t&&(window.onbeforeunload=null,location.reload())},error:function(){e._tooltips(e.networkErrorStr)}})}var e=this;page.is_edit&&$(".select-editor").delegate(".select-opt","click",function(e){var a,i=($(this).text(),$(this).data("value")),o=($(this).data("id"),$("#blog-form")),s=$(o).find("input[name=title]").val().trim(),n=$(o).find("textarea[name=content]").val().trim();""!=s||""!=n?(a=confirm("切换编辑器将会丢失未保存的内容，确定离开吗？"),a&&t(i)):t(i)})},closeWindow:function(){window.onbeforeunload=function(){var t=$("#blog-form"),e=$(t).find("input[name=title]").val().trim(),a=$(t).find("textarea[name=content]").val().trim();if(""!=e||""!=a)return window.localStorage.setItem("mdblog",""),"确认放弃此文章"}},autoFocusToTitle:function(){"false"==page.is_edit&&$(document).ready(function(){$("[name='title']").focus()})},abstractAutoHeight:function(){var t=(page.blog_editor,{max:170,min:18});$("[name='abstracts']").on("focus",function(){$(this).height(t.max),$(".edit-fixed-header").addClass("edit-flex-header")}).on("blur",function(){$(this).height(t.min),setTimeout(function(){$(".edit-fixed-header").removeClass("edit-flex-header")},200)})},scrollEditBodyFixed:function(){var t=!1,e=($(".edit-fixed-header"),$(".edit-fixed-footer"),$("#navbar-header .top"),$(".blog-edit")),a=$(".editor-toggle"),i=($(window).height(),$(".editor-toggle").offset().left-10),o=null,s=$(".edit-box").offset().top;$(window).on("scroll",function(n){var l,r;n.preventDefault(),l=$(this),o&&(clearTimeout(o),o=null),r=$(window).scrollTop(),o=setTimeout(function(){r>=s&&!t?(e.addClass("edit-fixed-size"),a.addClass("editor-toggle-fixed").css("left",i),$(window).scrollTop(s),clearTimeout(o),t=!0):t&&r<s&&(e.removeClass("edit-fixed-size"),a.removeClass("editor-toggle-fixed").css("left","auto"),t=!1)},0)})},_formDataListenHandle:function(){this._checkCanSaveBlog(),this.isAllowStashAuto=!0},formDataListener:function(){var t=this,e=null;this.formElement.find("input, textarea").on("input propertychange change",function(){var a=$(this);e&&(clearTimeout(e),e=null),e=setTimeout(function(){""!=$(a).val()&&t._formDataListenHandle()},200)})},register:function(){this.deleteTags(),this.addTags(),this.initTagsInput(),this.addCatalog(),this.mdeditorTextAreaFlex(),this._edit_catalog_default(),this.selectValue(),this.saveBlog(),this.deleteCatalog(),this.stashDraf(),this.initEditor(),this.toggleEditor(),this.closeWindow(),this.goToTop(),this.offonToggle(),this.autoFocusToTitle(),this.abstractAutoHeight(),this.scrollEditBodyFixed(),this._checkCanSaveBlog(),this.formDataListener(),t.personal_msg_tips()}},e});